#!/bin/sh
# Pre-push hook for Zarinpal Platform
# Runs essential checks including security scan and race detection

echo "üöÄ Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if there are any Go files
if ! find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" | grep -q . 2>/dev/null; then
    echo "${GREEN}‚úÖ No Go files to check${NC}"
    exit 0
fi

# 1. Build check (fast and essential)
echo "üî® Building..."
if ! go build ./... 2>&1; then
    echo "${RED}‚ùå Build failed${NC}"
    echo "Fix build errors before pushing"
    exit 1
fi
echo "${GREEN}‚úÖ Build successful${NC}"

# 2. Security scan
echo "üîí Running security scan..."
if command -v gosec >/dev/null 2>&1; then
    if ! gosec -exclude=G103,G404,G301,G304 -quiet ./... 2>&1; then
        echo "${RED}‚ùå Security scan failed${NC}"
        echo "Security vulnerabilities detected. Please review and fix before pushing"
        echo "Run 'gosec -exclude=G103,G404,G301,G304 ./...' for detailed output"
        exit 1
    fi
    echo "${GREEN}‚úÖ Security scan passed${NC}"
else
    echo "${YELLOW}‚ö†Ô∏è  gosec not installed, skipping security scan${NC}"
    echo "   Install with: make install-tools"
fi

# 3. Run tests with race detector
echo "üèÅ Running tests with race detector..."
if ! go test ./... -race -timeout 3m 2>&1; then
    echo "${RED}‚ùå Tests with race detector failed${NC}"
    echo "Fix failing tests or race conditions before pushing"
    exit 1
fi
echo "${GREEN}‚úÖ Tests with race detector passed${NC}"

echo ""
echo "${GREEN}‚úÖ All checks passed! Safe to push${NC}"
exit 0
