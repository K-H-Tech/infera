#!/bin/sh
# Commit message hook for Zarinpal Platform
# Validates commit message format

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    exit 0
fi

# Skip revert commits
if echo "$COMMIT_MSG" | grep -q "^Revert"; then
    exit 0
fi

# Get first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -1)

# Check format: type/subject (allows spaces and hyphens)
# Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)/.+"

if ! echo "$SUBJECT" | grep -qE "$PATTERN"; then
    echo "${RED}❌ Invalid commit message format${NC}"
    echo ""
    echo "Format: ${YELLOW}<type>/<subject>${NC}"
    echo ""
    echo "Types:"
    echo "  - feat     → New feature"
    echo "  - fix      → Bug fix"
    echo "  - docs     → Documentation changes"
    echo "  - style    → Code style changes"
    echo "  - refactor → Code refactoring"
    echo "  - test     → Adding or updating tests"
    echo "  - chore    → Maintenance tasks"
    echo "  - perf     → Performance improvements"
    echo "  - ci       → CI/CD changes"
    echo "  - build    → Build system changes"
    echo ""
    echo "Examples:"
    echo "  ${GREEN}feat/add user service${NC}"
    echo "  ${GREEN}fix/update linter${NC}"
    echo "  ${GREEN}docs/update readme${NC}"
    echo "  ${GREEN}refactor/simplify error handling${NC}"
    echo ""
    echo "Your commit message:"
    echo "  ${RED}$SUBJECT${NC}"
    exit 1
fi

# Check subject length (max 72 chars for first line)
if [ ${#SUBJECT} -gt 72 ]; then
    echo "${RED}❌ Commit subject is too long${NC}"
    echo "Maximum: 72 characters"
    echo "Current: ${#SUBJECT} characters"
    echo ""
    echo "${YELLOW}Subject: $SUBJECT${NC}"
    exit 1
fi

echo "${GREEN}✅ Commit message format is valid${NC}"
exit 0
