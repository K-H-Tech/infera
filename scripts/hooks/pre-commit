#!/bin/sh
# Pre-commit hook for Zarinpal Platform
# This hook runs before each commit to ensure code quality

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if golangci-lint is installed
if ! command -v golangci-lint &> /dev/null; then
    echo "${YELLOW}‚ö†Ô∏è  golangci-lint is not installed${NC}"
    echo "Install it with: brew install golangci-lint"
    echo "Or visit: https://golangci-lint.run/usage/install/"
    exit 1
fi

# Check if gofmt is available
if ! command -v gofmt &> /dev/null; then
    echo "${RED}‚ùå gofmt is not available${NC}"
    exit 1
fi

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' | grep -v '\.pb\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "${GREEN}‚úÖ No Go files to check${NC}"
    exit 0
fi

# Formatting is skipped in pre-commit hook
# Run 'make format' manually if needed
echo "‚ÑπÔ∏è  Skipping format check (run 'make format' manually if needed)"

# Run golangci-lint on staged files
echo "üîé Running linter on staged files..."

# Create a temporary directory for staged files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Copy staged files to temp directory
for file in $STAGED_GO_FILES; do
    if [ -f "$file" ]; then
        mkdir -p "$TEMP_DIR/$(dirname $file)"
        cp "$file" "$TEMP_DIR/$file"
    fi
done

# Run linter only on new/modified code
if ! golangci-lint run --new-from-rev=HEAD~1 --timeout=5m 2>&1; then
    echo "${RED}‚ùå Linting failed${NC}"
    echo ""
    echo "Fix the issues above or run: ${YELLOW}make lint${NC}"
    exit 1
fi

echo "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
exit 0
